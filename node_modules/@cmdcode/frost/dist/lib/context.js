import { Buff } from '@cmdcode/buff';
import { get_point_state } from '../ecc/state.js';
import { lift_x } from '../ecc/util.js';
import { get_challenge } from '../lib/helpers.js';
import { get_group_binders, get_group_prefix, get_group_pubnonce, get_nonce_ids } from './commit.js';
export function get_group_key_context(pubkey, tweaks) {
    const int_pk = Buff.bytes(pubkey).hex;
    const int_pt = lift_x(int_pk);
    const group_pt = get_point_state(int_pt, tweaks);
    const group_pk = group_pt.point.toHex(true);
    return { int_pk, int_pt, group_pk, group_pt };
}
export function get_group_commit_context(key_ctx, pnonces, message) {
    const group_pubkey = key_ctx.group_pk;
    const bind_prefix = get_group_prefix(pnonces, group_pubkey, message).hex;
    const bind_factors = get_group_binders(pnonces, bind_prefix);
    const group_pn = get_group_pubnonce(pnonces, bind_factors);
    const indexes = get_nonce_ids(pnonces);
    const challenge = get_challenge(group_pn, group_pubkey, message);
    message = Buff.bytes(message).hex;
    return { bind_prefix, bind_factors, challenge, pnonces, group_pn, indexes, message };
}
export function get_group_signing_ctx(group_pk, pnonces, message, tweaks) {
    const key_ctx = get_group_key_context(group_pk, tweaks);
    const com_ctx = get_group_commit_context(key_ctx, pnonces, message);
    return { ...key_ctx, ...com_ctx };
}
